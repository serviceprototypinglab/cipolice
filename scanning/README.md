# Image Scanner

Wraps around the trivy image scanner. Will print the image
tag and the highest CVE severity level found in the image.

> The scanning component has been migrated from Clair to trivy for an easier integration in pipeline or CI/CD usecases. Some functions may not be fully tested with the new scanning engine.

## Prerequisites

- Install Docker
- Install trivy, options can be found [here](https://aquasecurity.github.io/trivy/latest/getting-started/installation/)
- Install Klar, erlang and RabbitMQ server with `scanner_setup.sh` (optional for scanner only use-case)
- `pip install -r requirements.txt`

## Build Scanner Container

```
docker build -t <repo>/<image-name>:<tag> .
```

## Deploying on Openshift (Experimental)

Use the "oc" branch of this repository to deploy the scanner to Openshift. Please keep in mind this deployment is experimental. The branch has a modified README with the setup instructions to recreate the deployment.

## Initial configuration

Use:
```
$ python3 scan.py config
```
to select HTTP or RabbitMQ mode, to match the mode the rule engine operates in. This is written to a configuration file so it must only be changed if the rule engine mode changes.

## Usage

The program has 4 modes, 'cluster', 'detail', 'scan' and 'experiment'.

Available commands are:

```
python3 scan.py scan <image>        # run scan mode on single image
python3 scan.py detail <image>      # run detailed mode on single image
python3 scan.py experiment          # scan all DockerHub library images
python3 scan.py cluster             # scan all images found on an OpenShift cluster
```

### Scan mode

The scanner will scan the given image using trivy.
It will print the 'message' that will be sent to the policy engine.

This mode can also be used for local images.

Example:
```
$ python3 scan.py scan nginx:latest

...

{'image': 'local/executor:latest', 'level': 4, 'avg': 2.3706896551724137}
```
The severity levels for clair are:
- UNKNOWN (1)
- LOW (2)
- MEDIUM (3)
- HIGH (4)
- CRITICAL (5)

Refer to trivy's documentation for a detailed explanation of the severity levels.

This option will submit the result to the rule engine via RabbitMQ or HTTP.

### Detail mode

If the detailed output from trivy is desired, run the above example as follows:

```
$ python3 scan.py detail nginx:latest
```

This option will generate a report of all CVEs at both stdout and a file called
`output.json`

The user will then have the option to manually whitelist the image, overwriting an
automated blacklist policy generated by the rule engine.

### Cluster mode

Cluster mode will attempt to detect all images deployed to the current Openshift namespace (requires that the user is logged into the CLI) and then scan all of them.

```
$ python3 scan.py cluster
```

### Experiment mode

Experiment mode will scan all images of the official `library` registry to
obtain an overview of the security status of official images.

This mode offers two option that can be set via environment vairables:

- `CIPOLICE_TIMESTAMPED_OUTPUT`
    - `False` (default) - write output files without timestamp
    - `True` - write output files with date timestamp (e.g. `2021-01-01-max.json`)
- `CIPOLICE_OUTPUT_PATH`
    - `.` (default) - write output files to current directory
    - `<path>` - path to write output files to
